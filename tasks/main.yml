- name: mixin directory
  file:
    path: /etc/systemd/resolved.conf.d
    state: directory
  tags:
    - resolved

- name: link resolver
  notify:
    - restart resolved
  file:
    src: /run/systemd/resolve/stub-resolv.conf
    dest: /etc/resolv.conf
    force: yes
    state: link
  tags:
    - resolved

- name: mask dhcp
  notify:
    - restart resolved
  when: resolved_dhcp_mask
  file:
    src: /dev/null
    dest: /etc/systemd/resolved.conf.d/{{ resolved_dhcp_name }}
    force: yes
    state: link
  tags:
    - resolved

- name: unmask dhcp
  notify:
    - restart resolved
  when: not resolved_dhcp_mask
  file:
    path: /etc/systemd/resolved.conf.d/{{ resolved_dhcp_name }}
    state: absent
  tags:
    - resolved

- name: write config
  notify:
    - restart resolved
  template:
    src: config.j2
    dest: /etc/systemd/resolved.conf
  tags:
    - resolved

- name: service start
  systemd:
    name: systemd-resolved
    state: started
    daemon_reload: yes
    masked: no
    enabled: yes
  tags:
    - resolved
